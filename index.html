<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>草薙京：森林百鬼夜行</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial', sans-serif; }
        canvas { display: block; background: linear-gradient(#1a2a6c, #b21f1f, #fdbb2d); margin: 0 auto; }
        .ui-layer { position: fixed; top: 15px; left: 15px; pointer-events: none; color: white; text-shadow: 2px 2px #000; }
        .hp-bar-bg { width: 220px; height: 15px; background: #333; border: 2px solid #eee; margin-top: 5px; }
        .hp-bar-fill { width: 100%; height: 100%; background: linear-gradient(to right, #ff416c, #ff4b2b); transition: width 0.3s; }
        .controls { position: fixed; bottom: 25px; left: 15px; right: 15px; display: flex; justify-content: space-between; pointer-events: none; }
        .btn { width: 70px; height: 70px; background: rgba(0,0,0,0.6); border: 2px solid #ff9d00; border-radius: 50%; pointer-events: auto; display: flex; align-items: center; justify-content: center; color: white; user-select: none; font-weight: bold; }
        .d-pad { display: flex; gap: 12px; }
        #btnAttack { background: #d35400; box-shadow: 0 0 15px #ff6600; position: relative; overflow: hidden; }
        #cd-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background: rgba(255,255,255,0.4); }
        .score { font-size: 20px; margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="ui-layer">
    <div class="score">擊殺數: <span id="kill-count">0</span></div>
    <div>草薙京 HP</div>
    <div class="hp-bar-bg"><div id="hp-fill" class="hp-bar-fill"></div></div>
</div>

<canvas id="gameCanvas"></canvas>

<div class="controls">
    <div class="d-pad">
        <div class="btn" id="btnLeft">←</div>
        <div class="btn" id="btnRight">→</div>
        <div class="btn" id="btnJump">跳躍</div>
    </div>
    <div class="btn" id="btnAttack">
        大蛇薙
        <div id="cd-overlay"></div>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = 400;

// 遊戲變數
let player = { x: 50, y: 300, w: 35, h: 50, dy: 0, speed: 5, hp: 100, jumping: false, ground: 300, invincible: 0 };
let flames = []; // 大蛇薙火焰
let enemies = [];
let kills = 0;
let castlePos = 5000; // 城堡更遠了，中間有無數怪物
let cameraX = 0;
let keys = {};
let attackCD = 0;
let spawnTimer = 0; // 怪物生成計時器

// 初始化控制
window.addEventListener('keydown', e => keys[e.code] = true);
window.addEventListener('keyup', e => keys[e.code] = false);

function setupBtn(id, key) {
    const btn = document.getElementById(id);
    btn.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; });
    btn.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; });
}
setupBtn('btnLeft', 'ArrowLeft');
setupBtn('btnRight', 'ArrowRight');
setupBtn('btnJump', 'ArrowUp');
document.getElementById('btnAttack').addEventListener('touchstart', (e) => { e.preventDefault(); handleAttack(); });
window.addEventListener('keydown', e => { if(e.code === 'Space') handleAttack(); });

function handleAttack() {
    if (attackCD <= 0) {
        // 發射大蛇薙 (長條形火焰)
        flames.push({ x: player.x + 20, y: player.y + 10, w: 40, h: 20, speed: 12 });
        attackCD = 100;
    }
}

function spawnEnemy() {
    const type = Math.random() > 0.4 ? 'snake' : 'tiger';
    const enemy = {
        x: cameraX + canvas.width + Math.random() * 300,
        y: type === 'snake' ? 330 : 310,
        w: type === 'snake' ? 35 : 55,
        h: type === 'snake' ? 20 : 45,
        type: type,
        speed: type === 'snake' ? 2 + Math.random() * 2 : 4 + Math.random() * 2,
        hp: type === 'tiger' ? 1 : 1 // 目前設定一擊必殺
    };
    enemies.push(enemy);
}

function resetGame() {
    player.hp = 100; player.x = 50; player.invincible = 0;
    enemies = []; flames = []; kills = 0; attackCD = 0;
    document.getElementById('kill-count').innerText = "0";
}

function update() {
    // 玩家控制
    if (keys['ArrowRight']) player.x += player.speed;
    if (keys['ArrowLeft'] && player.x > cameraX) player.x -= player.speed;
    if (keys['ArrowUp'] && !player.jumping) { player.dy = -14; player.jumping = true; }

    player.dy += 0.8;
    player.y += player.dy;
    if (player.y > player.ground) { player.y = player.ground; player.dy = 0; player.jumping = false; }

    cameraX = player.x - 100;

    // CD 恢復
    if (attackCD > 0) {
        attackCD -= 3;
        document.getElementById('cd-overlay').style.height = attackCD + "%";
    }

    // 火焰邏輯
    flames.forEach((f, fi) => {
        f.x += f.speed;
        enemies.forEach((e, ei) => {
            if (f.x < e.x + e.w && f.x + f.w > e.x && f.y < e.y + e.h && f.y + f.h > e.y) {
                enemies.splice(ei, 1);
                kills++;
                document.getElementById('kill-count').innerText = kills;
            }
        });
        if (f.x > cameraX + canvas.width) flames.splice(fi, 1);
    });

    // 怪物生成邏輯：怪物越多，難度隨擊殺數增加
    spawnTimer++;
    if (spawnTimer > Math.max(20, 60 - Math.floor(kills/5))) { 
        spawnEnemy();
        spawnTimer = 0;
    }

    // 怪物移動與傷害
    if (player.invincible > 0) player.invincible--;
    enemies.forEach((e, ei) => {
        e.x -= e.speed;
        // 碰撞檢測
        if (player.x < e.x + e.w && player.x + player.w > e.x && player.y < e.y + e.h && player.y + player.h > e.y) {
            if (player.invincible <= 0) {
                player.hp -= 20;
                player.invincible = 45;
                if (player.hp <= 0) { alert("戰鬥失敗！擊殺數: " + kills); resetGame(); }
            }
        }
        // 移除過後的怪物
        if (e.x < cameraX - 100) enemies.splice(ei, 1);
    });

    document.getElementById('hp-fill').style.width = player.hp + "%";

    // 勝利條件
    if (player.x > castlePos) {
        alert("你殺出重圍抵達了城堡！總擊殺: " + kills);
        resetGame();
    }
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(-cameraX, 0);

    // 地面
    ctx.fillStyle = '#1e392a';
    ctx.fillRect(cameraX, 350, canvas.width, 50);

    // 主角
    if (player.invincible % 8 < 4) {
        ctx.fillStyle = '#fff'; // 本體白色
        ctx.fillRect(player.x, player.y, player.w, player.h);
        ctx.strokeStyle = '#ff6600';
        ctx.strokeRect(player.x, player.y, player.w, player.h);
    }

    // 火焰 (大蛇薙)
    flames.forEach(f => {
        ctx.fillStyle = '#ffcc00';
        ctx.shadowBlur = 15;
        ctx.shadowColor = '#ff3300';
        ctx.fillRect(f.x, f.y, f.w, f.h);
        ctx.shadowBlur = 0;
    });

    // 怪物
    enemies.forEach(e => {
        ctx.fillStyle = e.type === 'snake' ? '#00ff44' : '#ff0000';
        ctx.fillRect(e.x, e.y, e.w, e.h);
        // 怪物的眼睛（讓它看起來更兇）
        ctx.fillStyle = 'white';
        ctx.fillRect(e.x + 5, e.y + 5, 5, 5);
    });

    // 城堡 (遠方)
    ctx.fillStyle = '#444';
    ctx.fillRect(castlePos, 150, 150, 200);

    ctx.restore();
    update();
    requestAnimationFrame(draw);
}

draw();
</script>
</body>
</html>
