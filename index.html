<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>森林大冒險</title>
    <style>
        body { margin: 0; overflow: hidden; background: #222; font-family: Arial, sans-serif; }
        canvas { display: block; background: #4a7d4a; margin: 0 auto; }
        .controls { position: fixed; bottom: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; pointer-events: none; }
        .btn { width: 60px; height: 60px; background: rgba(255,255,255,0.3); border-radius: 50%; pointer-events: auto; display: flex; align-items: center; justify-content: center; color: white; user-select: none; font-weight: bold; }
        .d-pad { display: flex; gap: 10px; }
    </style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<div class="controls">
    <div class="d-pad">
        <div class="btn" id="btnLeft">←</div>
        <div class="btn" id="btnRight">→</div>
        <div class="btn" id="btnJump">↑</div>
    </div>
    <div class="btn" id="btnAttack">投石</div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// 自動調整畫布大小
canvas.width = window.innerWidth;
canvas.height = 300; 

// 遊戲狀態
let player = { x: 50, y: 200, w: 30, h: 40, dy: 0, speed: 4, jumping: false, ground: 200 };
let stones = [];
let enemies = [
    { x: 400, y: 210, w: 30, h: 20, type: 'snake', speed: 2 },
    { x: 800, y: 190, w: 40, h: 40, type: 'tiger', speed: 3 }
];
let castle = { x: 1500, y: 140, w: 100, h: 100 };
let cameraX = 0;
let keys = {};
let gameOver = false;

// 監聽按鍵
window.addEventListener('keydown', e => keys[e.code] = true);
window.addEventListener('keyup', e => keys[e.code] = false);

// 輔助函式：觸控事件
function setupBtn(id, key) {
    const btn = document.getElementById(id);
    btn.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; });
    btn.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; });
}
setupBtn('btnLeft', 'ArrowLeft');
setupBtn('btnRight', 'ArrowRight');
setupBtn('btnJump', 'ArrowUp');
document.getElementById('btnAttack').addEventListener('touchstart', (e) => { e.preventDefault(); throwStone(); });
window.addEventListener('keydown', e => { if(e.code === 'Space') throwStone(); });

function throwStone() {
    stones.push({ x: player.x + 20, y: player.y + 10, speed: 7 });
}

function update() {
    if (gameOver) return;

    // 玩家移動
    if (keys['ArrowRight']) player.x += player.speed;
    if (keys['ArrowLeft']) player.x -= player.speed;
    if (keys['ArrowUp'] && !player.jumping) {
        player.dy = -12;
        player.jumping = true;
    }

    // 重力
    player.dy += 0.6;
    player.y += player.dy;
    if (player.y > player.ground) {
        player.y = player.ground;
        player.dy = 0;
        player.jumping = false;
    }

    // 鏡頭跟隨
    cameraX = player.x - 100;

    // 石頭邏輯
    stones.forEach((s, si) => {
        s.x += s.speed;
        enemies.forEach((e, ei) => {
            if (s.x > e.x && s.x < e.x + e.w && s.y > e.y && s.y < e.y + e.h) {
                enemies.splice(ei, 1);
                stones.splice(si, 1);
            }
        });
    });

    // 敵人移動與碰撞
    enemies.forEach(e => {
        e.x -= e.speed;
        if (player.x < e.x + e.w && player.x + player.w > e.x && player.y < e.y + e.h && player.y + player.h > e.y) {
            alert("被抓到了！重新開始");
            resetGame();
        }
    });

    // 勝利條件
    if (player.x > castle.x) {
        alert("抵達城堡！恭喜過關！");
        resetGame();
    }
}

function resetGame() {
    player.x = 50;
    enemies = [
        { x: 400, y: 210, w: 30, h: 20, type: 'snake', speed: 2 },
        { x: 800, y: 190, w: 40, h: 40, type: 'tiger', speed: 3 },
        { x: 1200, y: 210, w: 30, h: 20, type: 'snake', speed: 2 }
    ];
    stones = [];
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(-cameraX, 0);

    // 畫草地
    ctx.fillStyle = '#2d5a27';
    ctx.fillRect(0, 240, 2000, 60);

    // 畫玩家 (藍色方塊代替)
    ctx.fillStyle = '#3498db';
    ctx.fillRect(player.x, player.y, player.w, player.h);

    // 畫敵人
    enemies.forEach(e => {
        ctx.fillStyle = e.type === 'snake' ? '#2ecc71' : '#e67e22'; // 蛇綠色，老虎橘色
        ctx.fillRect(e.x, e.y, e.w, e.h);
    });

    // 畫石頭
    ctx.fillStyle = '#95a5a6';
    stones.forEach(s => ctx.beginPath(), ctx.arc(s.x, s.y, 5, 0, Math.PI*2), ctx.fill());
    stones.forEach(s => { ctx.beginPath(); ctx.arc(s.x, s.y, 5, 0, Math.PI*2); ctx.fill(); });

    // 畫城堡
    ctx.fillStyle = '#7f8c8d';
    ctx.fillRect(castle.x, castle.y, castle.w, castle.h);
    ctx.fillStyle = 'black';
    ctx.fillRect(castle.x + 40, castle.y + 60, 20, 40); // 門

    ctx.restore();
    
    update();
    requestAnimationFrame(draw);
}

draw();
</script>
</body>
</html>
